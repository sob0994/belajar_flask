{% set title = 'Daftar Provinsi'%} {% extends 'base.html' %} {% block content %}
<style>
  @import url("{{url_for('static',filename='src/css/datatable.css')}}");
  p.status {
    margin: 0;
    font-size: small;
    color: red;
    margin-top: 3px;
    font-weight: 600;
  }
</style>

<div class="by-box mb-5">
  <div class="card-header bg-primary text-light">List Data Kota</div>

  <div class="row justify-content-center py-5 py-xxl-10 mx-2">
    <div class="col-xxl-5 col-xl-8">
      <table
        id="example"
        class="table table-sm table-striped"
        style="width: 100%"
      >
        <thead>
          <tr>
            <th>Kode</th>
            <th>Provinsi</th>
            <th>Jumlah kota</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          {% for itm in provinsi %}
          <tr>
            <td>{{itm.id}}</td>
            <td><a href="/data/provinsi/{{itm.id}}">{{itm.nama}}</a></td>
            <td style="text-align: center">{{itm.jumlahKota}}</td>
            <td style="text-align: right">
              <a href="/data/provinsi/{{itm.id}}" class="btn btn-sm btn-primary"
                ><i class="bx bx-pencil"></i
              ></a>
              <a href="/{{ itm.id }}" class="btn btn-sm btn-danger">
                <i class="bx bx-trash"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th>Kode</th>
            <th>Provinsi</th>
            <th>Jumlah kota</th>
            <th>Aksi</th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<!-- Modal Start -->
<div class="mymodal-container" id="mymodal">
  <div class="mymodal-content p-3 col-11 col-sm-8 col-md-6">
    <div class="mymodal-header">
      <h5>Input Data Provinsi</h5>
    </div>
    <div class="mymodal-body">
      <nav>
        <div class="nav nav-tabs" id="nav-tab" role="tablist">
          <button
            class="nav-link active"
            id="nav-home-tab"
            data-bs-toggle="tab"
            data-bs-target="#nav-home"
            type="button"
            role="tab"
            aria-controls="nav-home"
            aria-selected="true"
          >
            Input Form
          </button>
          <button
            class="nav-link"
            id="import_data-tab"
            data-bs-toggle="tab"
            data-bs-target="#import_data"
            type="button"
            role="tab"
            aria-controls="import_data"
            aria-selected="false"
          >
            Import Data
          </button>
        </div>
      </nav>

      <!-- Content Tab -->
      <div class="tab-content" id="nav-tabContent">
        <div
          class="tab-pane fade show active"
          id="nav-home"
          role="tabpanel"
          aria-labelledby="nav-home-tab"
        >
          <div class="by-box">
            <div class="row justify-content-center">
              <div class="col">
                <h4 class="text-primary mb-1">Form Input Provinsi</h4>
                <h6 class="card-title mb-4">
                  Menambahkan provinsi baru ke database
                </h6>
                <hr />
                <form action="">
                  <div class="row gx-3">
                    <div class="mb-3 col-md-6">
                      <label for="kode" class="small text-primary mb-1"
                        >Kode Provinsi</label
                      >
                      <input
                        required
                        type="text"
                        class="form-control text-secondary"
                        id="kode"
                        name="kode"
                        placeholder="Kode Provinsi"
                      />
                    </div>
                    <div class="mb-3 col-md-6">
                      <label for="provinsi" class="small text-primary mb-1"
                        >Nama Provinsi</label
                      >
                      <input
                        required
                        type="text"
                        class="form-control text-secondary"
                        id="provinsi"
                        name="provinsi"
                        placeholder="Masukkan nama provinsi"
                      />
                    </div>
                  </div>
                  <div class="d-inline-flex">
                    <button class="btn btn-primary" type="submit">
                      Simpan
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div
          class="tab-pane fade"
          id="import_data"
          role="tabpanel"
          aria-labelledby="import_data-tab"
        >
          <!-- Tab Pane Import Start -->
          <form
            method="post"
            name="import_file"
            enctype="multipart/form-data"
            id="import_file"
            class="mt-3"
          >
            <label for="pilihFile" class="form-label">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                x="0px"
                y="0px"
                width="30"
                height="30"
                viewBox="0 0 48 48"
                style="fill: #000000"
              >
                <path
                  fill="#169154"
                  d="M29,6H15.744C14.781,6,14,6.781,14,7.744v7.259h15V6z"
                ></path>
                <path
                  fill="#18482a"
                  d="M14,33.054v7.202C14,41.219,14.781,42,15.743,42H29v-8.946H14z"
                ></path>
                <path
                  fill="#0c8045"
                  d="M14 15.003H29V24.005000000000003H14z"
                ></path>
                <path fill="#17472a" d="M14 24.005H29V33.055H14z"></path>
                <g>
                  <path
                    fill="#29c27f"
                    d="M42.256,6H29v9.003h15V7.744C44,6.781,43.219,6,42.256,6z"
                  ></path>
                  <path
                    fill="#27663f"
                    d="M29,33.054V42h13.257C43.219,42,44,41.219,44,40.257v-7.202H29z"
                  ></path>
                  <path
                    fill="#19ac65"
                    d="M29 15.003H44V24.005000000000003H29z"
                  ></path>
                  <path fill="#129652" d="M29 24.005H44V33.055H29z"></path>
                </g>
                <path
                  fill="#0c7238"
                  d="M22.319,34H5.681C4.753,34,4,33.247,4,32.319V15.681C4,14.753,4.753,14,5.681,14h16.638 C23.247,14,24,14.753,24,15.681v16.638C24,33.247,23.247,34,22.319,34z"
                ></path>
                <path
                  fill="#fff"
                  d="M9.807 19L12.193 19 14.129 22.754 16.175 19 18.404 19 15.333 24 18.474 29 16.123 29 14.013 25.07 11.912 29 9.526 29 12.719 23.982z"
                ></path>
              </svg>
              Import from Excel, Csv, Json</label
            >
            <input
              type="file"
              name="pilihFile"
              id="pilihFile"
              accept=".xls,.xlsx,.xlsb,.csv,.json"
              class="form-control form-control-sm"
            />
            <p class="status" id="msg_pilihFile"></p>
            <button
              id="btnImport"
              type="submit"
              class="btn btn-sm btn-warning form-control mt-2"
            >
              Import
            </button>
          </form>

          <!-- Tab Pane Import Start -->
        </div>
      </div>
    </div>
    <div class="mymodal-footer grid">
      <!-- <button class="btn btn-sm btn-primary m-1">Save</button> -->
      <button class="btn btn-sm btn-secondary m-1" close-modal>close</button>
    </div>
  </div>
</div>
<!-- Modal End -->

{% include 'style/datatable.html' %}
<script>
  $(document).ready(function () {
    $("#example").DataTable({
      paging: false,
      info: false,
      scrollY: 300,
      scrollX: true,
      columns: [null, null, { width: "20%" }, null],
    });
    addDataTableModalButton("example", "#mymodal", "Tambah");

    // on Submit Import from Excel
    $("#import_file").submit((e) => {
      e.preventDefault();
      let data = new FormData();
      const file = document.forms["import_file"]["pilihFile"];
      const btnImport = document.getElementById("btnImport");
      // Validasi Procces
      let errors = {};
      const cekFIleSplit = file.value.split(".");
      const cekkerFlieSplit = file.accept.replaceAll(".", "").split(",");
      const hasilCek = cekFIleSplit.some((rr) => cekkerFlieSplit.includes(rr));
      if (!hasilCek) {
        errors.pilihFile = "Silahkan pilih file Excel";
        addStatus(errors, "pilihFile", errors.pilihFile);
      } else {
        delete errors.pilihFile;
        addStatus(errors, "pilihFile", errors.pilihFile);
        // Init data
        data.append("filePath", file.files[0]);
        // Ajax Request
        $.ajax({
          url: "/data/provinsi?import=true",
          type: "post",
          data: data,
          processData: false,
          contentType: false,
          beforeSend: () => {
            btnImport.setAttribute("disabled", "on");
            btnImport.innerText = "Sending...";
          },
          success: (ok) => {
            if (ok?.error) {
              errors.pilihFile = ok.error;
              addStatus(errors, "pilihFile", errors.pilihFile);
            } else {
              delete errors.pilihFile;
              addStatus(errors, "pilihFile", errors.pilihFile);
              alert("Import Sukses");
            }
            btnImport.removeAttribute("disabled");
            btnImport.innerText = "Import";
          },
          error: (err) => {
            console.log(err);
            alert("Error bos,, hehe");
          },
        });
      }
    });
  });
  // Function helpers Start=================================================
  const valid = (data) => {
    let error = {};
    if (!data.username || data.username === "")
      error.username = "Username wajib diisi";
    if (!data.password || data.password === "")
      error.password = "Password wajib diisi";

    return error;
  };

  const addStatus = (errors, name, msg) => {
    if (errors?.[name]) {
      document.getElementById(`msg_${name}`).classList.add("show");
      document.getElementById(`msg_${name}`).innerHTML = msg;
    } else {
      document.getElementById(`msg_${name}`).classList.remove("show");
      document.getElementById(`msg_${name}`).innerHTML = "";
    }
  };
  // Function helpers End=================================================
</script>
{% endblock %}
